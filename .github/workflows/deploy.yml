name: Deploy and Test

on:
  push:
    branches: ['master']
    paths:
    - helm-chart/**
    - scripts/**
    - acceptance-tests/**
    - .github/**
  workflow_dispatch:


jobs:
  deploy:
    runs-on: ubuntu-20.04
    environment:
      name: dev
      url: https://dev.renku.ch
    steps:
    - uses: actions/checkout@v2
    - name: deploy renku
      uses: ./actions/deploy-renku
      env:
        DOCKER_PASSWORD: ${{ secrets.RENKU_DOCKER_PASSWORD }}
        DOCKER_USERNAME: ${{ secrets.RENKU_DOCKER_USERNAME }}
        KUBECONFIG: "${{ github.workspace }}/renkubot-kube.config"
        RENKU_RELEASE: renku
        RENKU_VALUES_FILE: "${{ github.workspace }}/values.yaml"
        RENKU_VALUES: ${{ secrets.CD_VALUES }}
        RENKUBOT_KUBECONFIG: ${{ secrets.RENKUBOT_DEV_KUBECONFIG }}
        RENKU_BOT_DEV_PASSWORD: ${{ secrets.RENKU_BOT_DEV_PASSWORD }}
        RENKU_ANONYMOUS_SESSIONS: true
        RENKU_TESTS_ENABLED: true
        TEST_ARTIFACTS_PATH: "tests-artifacts-${{ github.sha }}"
        renku: "@master"
    - name: Notify slack
      if: success()
      env:
        RENKU_SLACK_BOT_TOKEN: ${{ secrets.RENKU_SLACK_BOT_TOKEN }}
      run: |
        curl -X POST https://slack.com/api/chat.postMessage \
             -H "Authorization: Bearer $RENKU_SLACK_BOT_TOKEN" \
             --data "channel=C9U45DL1H" \
             --data "text=https://dev.renku.ch has been updated! :tada:"
  test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - uses: actions/checkout@v2
    - name: Test
      env:
        KUBECONFIG: ${{ github.workspace }}/renkubot-kube.config
        RENKUBOT_KUBECONFIG: ${{ secrets.RENKUBOT_DEV_KUBECONFIG }}
      run: |
        echo "$RENKUBOT_KUBECONFIG" > renkubot-kube.config
        helm test renku --namespace renku --timeout 40m --logs
    - name: Download artifact for packaging on failure
      if: failure()
      uses: ./actions/download-test-artifacts
      env:
        RENKU_VALUES: ${{ secrets.CI_RENKU_VALUES }}
        TEST_ARTIFACTS_PATH: "tests-artifacts-${{ github.sha }}"
    - name: Upload screenshots on failure
      if: failure()
      uses: actions/upload-artifact@v1
      with:
        name: acceptance-test-artifacts
        path: ${{ github.workspace }}/test-artifacts/
    - name: Notify slack
      if: failure()
      env:
        RENKU_SLACK_BOT_TOKEN: ${{ secrets.RENKU_SLACK_BOT_TOKEN }}
      run: |
        curl -X POST https://slack.com/api/chat.postMessage \
             -H "Authorization: Bearer $RENKU_SLACK_BOT_TOKEN" \
             --data "channel=C9U45DL1H" \
             --data "text=Acceptance tests on https://dev.renku.ch failed! :scream_cat:"
